# AUTHCONTEXT

The first step to enable seamless deployment in your Business Central environment is to create an **environment** in your **GitHub repository**. This environment will be associated with a secret used for authentication.

---
First thing we need to do is to create a **Secret** in your **GitHub repository** with a name, which identifies your Business Central environment.

Navigate to your single-project repository (**repo1**), select **Settings** -> **Secrets and variables** -> **Actions** and click **New repository secret**. Enter a name for the secret that resmbles your Business Central environment concatenated to "_AUTHCONTEXT" and click **Add secret**. So it should look like {{Your-BC-Env-Name}}_AUTHCONTEXT.

| ![image](https://github.com/ciellosinc/Ciellos-BC-git-flow-template/blob/9d6d351e232620e793f7a0daf9b7e325a872a827/.images/NewAuthRepoSecret.png?raw=true) |
|-|

The value of this secret will be generated by the below powershell commands:

## Creating an AUTHCONTEXT that uses impersonation

Easiest way to create an authentication context with impersonation for AL-Go for GitHub is to use the following PowerShell line from a machine with the latest **BcContainerHelper** module installed. If not installed, instead of using only the last 3 lines of pwsh script, you can use the whole script which will install and import the module:

```powershell
#Check ExecutionPolicy
$ExecutionPolicies = @("AllSigned", "Bypass", "RemoteSigned", "Restricted", "Undefined", "Unrestricted")
$AllowedPolicies = @("Bypass", "RemoteSigned", "Unrestricted")
$ExecutionPolicy = Get-ExecutionPolicy -Scope Process
if ($ExecutionPolicy -notin $AllowedPolicies) {
    # Set ExecutionPolicy to Bypass if not already set to one of the allowed policies
    Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
}
Install-Module BcContainerHelper -Force -Scope CurrentUser -Verbose 
Import-Module BcContainerHelper -Scope Local -Force
# Check-BcContainerHelperPermissions -Fix
$tenantId = '{{Your-TenantId}}'
#Impersonation-AppSource
New-BcAuthContext -includeDeviceLogin -tenantID $tenantId | New-ALGoAuthContext | Set-Clipboard
```

This command will display the well-known device login text: **To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code XXXXXXX to authenticate.**

Complete the login with a Business Central user, which has access to deploy applications in the environment setup for continuous deployment. This will generate an Authorization context for the environment and Copy it automatically to your clipboard.

Return to the "Add Secret" dialog from the environment configuration screen, paste the secret into the "Value" field, and click **Add secret**.

| ![image](https://raw.githubusercontent.com/ciellosinc/Ciellos-BC-git-flow-template/9d6d351e232620e793f7a0daf9b7e325a872a827/.images/NewAuthRepoSecret1.png) |
|-|

Now, select **Actions** and select the **Publish To Environment** workflow add the name of your environment and click **Run workflow**. Inspect the workflow and see if deployment now deploys your apps:

| ![image](https://github.com/ciellosinc/Ciellos-BC-git-flow-template/blob/9d6d351e232620e793f7a0daf9b7e325a872a827/.images/PublishToEnv.png?raw=true) |
|-|

The URL under the deployment will navigate to the environment.

Opening the Business Central environment and navigating to **Extension Management** reveals that both apps from repo1 has been installed in the development scope. If the environment was a production environment, the apps would have been installed in the Global Scope as Per Tenant Extensions.

| ![image](https://github.com/microsoft/AL-Go/assets/10775043/40e5f9de-319c-4151-aa31-98a32732bfce) |
|-|

> \[!NOTE\]
> You need to update the AuthContext secret every 90 days for now.
